volumes:
  ny_taxi_postgres_data:
    driver: local
  kestra_postgres_data:
    driver: local
  kestra_data:
    driver: local

services:
  pgdatabase:
    image: postgres:18
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: ny_taxi
    ports:
      - "5432:5432"
    volumes:
      - ny_taxi_postgres_data:/var/lib/postgresql

  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.com
      - PGADMIN_DEFAULT_PASSWORD=root
    ports:
      - "8085:80"

  kestra_postgres:
    image: postgres:18
    volumes:
      - kestra_postgres_data:/var/lib/postgresql
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 10

  kestra:
    image: kestra/kestra:v1.1
    pull_policy: always
    # Note that this setup with a root user is intended for development purpose.
    # Our base image runs without root, but the Docker Compose implementation needs root to access the Docker socket
    # To run Kestra in a rootless mode in production, see: https://kestra.io/docs/installation/podman-compose
    user: "root"
    command: server standalone
    volumes:
      - kestra_data:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
    environment:
      SECRET_MYSECRET: ewogIHR5cGU6IHNlcnZpY2VfYWNjb3VudCwKICBwcm9qZWN0X2lkOiBrZXN0cmEtZGVtby00ODc3MTEsCiAgcHJpdmF0ZV9rZXlfaWQ6IDhmN2MwZmQ3NWFiMTdhZWE1NTJkNTMzNWEyN2JkMGVmMGI5YzgxNDcsCiAgcHJpdmF0ZV9rZXk6IC0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLW5NSUlFdlFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLY3dnZ1NqQWdFQUFvSUJBUUM5UXhxNmVnYzl5OThEbkNKeVJiY1JOTmJPcUI5NHJ5SVppaHNwZzczWDRQamI5WDZxaEFvaWI2b2EwNGJkbGc0c3hENTNtNkl0YWlxL0pueXNkMkFtNnN2VVA2d0tBOHdxTFV3Zk1tS1ZLNmVkVGNjOXFKcFM4QlVIV2FuOFNXY1hFR1JvWVB0Qmc5aFYwQm52UTdoV1JvQW9tdStxK2NTMHc4SUJHYk5sL3JFYnFqem1QbTVpS3RGdGFXQWU0MEFSelFmYnVSYUo3VlJoNmRzbjIycHdydTlRSG9vTDhmOE5yYnl0NnZxQXBMVGxUY29SNTlZN0NwSGltYzloblRuV0VDTHh3cUsvLzB3NWUzZEduZ1ExK2FZaTN5dnlTK2kvVVBCcVRLUndmcDdPU3h1aGtmWHRXWXR2K2M1ekZlb09KTFF5bDRYVGNraUVUSEYrVm5SRFVUQzNLbkFnTUJBQUVDZ2dFQVMxdmYxYVpuSWJ6K2xHZW1aK1dzQnc0OTlwTGhiTStRYXNTKzZuQU9xZ1NqbndxbUgrRXBZK0xRZVpRR0hFNzJYKzdYN0tva25pNnF6S2djNitvc25aRktNTWRqbk5LcFBTYVhjV2pLVUJUb2puZnBBRzBVM2JkSXVEK0VocmIzZkdDRGltZ3JRei9yTU9nSFcxNmhhZld1ZFJQWCtYSjVDd2FJSFFLVWE5aTk3UG5PWkgra2J3KzZyVktKaGt3SU5RUlpONysyUXUzbS9GSCtycEptV1lvcjJ3ZzlkVU9EN050Q0cxTGpjY25IaGdTbjFZNGxZY3lNS2FBZU5OQnhOS2p3RWFjZUVRVlZPK3FEaHdoV1dtRjBjRlhvZ2dMYVRhV2t3OVRFTnpLbW5WNmtuMi9sS255S284cGtxc0o4am5qd05OdGc0Ui9VU0I5ajFHWVUvT3h3MndRS0JnUUQ3dmhmWGFZMlZMMFJZajFIcG5pMndrSmp0NEM1aU1QeG13WVY1SU14QTZZMC9HMUlxNWsxczIxcmhCbmhBWjdib3lRa0cyck44OVIrNksrcURUbklNVlVGQkZSNVFRVWpaWmFIa0IxRmU0K2czYzRMUm1QenQycHFIZ2l6d0FuUkRTVHVUOFFhOXVTb21wZTc3ZTluZnRSakxTNjRBUmdkb3U4V2owRzFYY1VBNFFLQmdRREFkb0ZndjNVSUpjMnlDSkVXQXVNdTR1WHhxdlQ4S2VxZ25HSlU4Qm5nQkZpang2Zk5zS1lvY1VvZTFoM3dlcllsSWVCQUx1QzE5TjVlS1VpNkZtWTZjR2dZeWg4YXpUR3hzblVqRldKdTVXVFhVenhuSlRIM1I5bU1vbGpOS0o1emVyNHVWdXExWm1wb3RWVGFkL28xSmNBQ0FRQkgvMzZYRTJuWEExMW5CdDhod0tCZ0Juanp1ZmtmeDhjb1ZiS1JvNVNQR2pyVmFwZTV1MWxmK3JYMks1c01mc1BRNkViTXJrcm5JbkpkV3MzRXg3c2k2OGRIY1NLc1hMa2NzTGV5VnQvZnV1dU90TWxMV0VRVTI2V2cvdGdMelZpNGhJWk9mUmFCbkcrTGE1S0FQMGVBMzc0QlJ5TjZUZVIxM2ZxRU0za1NxeW9UNG5KbG40MmNJM3JYZlBjNjlPZ21CQW9HQVd6a1FuTTZJcnYzUGpuaW52VXNhRmxkaVg4c2I4SFhWa3J3Tlg0TDZVTExlcktwYWYrVGxySytkMlNYVnhRRDB5bjdYQW5yVDFiMmtqNk8rYWVCRmIzUUVnWmZlUGJLMnJpelNqY0Y2Q1dRVE92aEozZjNFUkJlN0pxeGdlTVZ5N1B0Vm56bk0xUmt2SHpkOTgyNXdZYlE1NmhyaWd3SDk2S2ZOWXZHR1dPbnA0c0NnWUVBMyt1OVEzL2hPMDNTakxCQVNqaVBudWxrSmdUOFUxYkRpMkR0Qk93b1lHeStoUVc3R1ZlUEN6bzFZbllMOTBKTlZhc2Rnb054c25aR0NPcnlyNlpCQW5QMHA2QXlaekdRL3l5VUlYMFVFMVEwNnZDMFQyMG5vc3hoM0pmZ3Q0VUFGN1ViZ1J5bmxRY1VrQlJuem5PZVdJbmpLb2kxbHMvV2M3NmdnSk5LaFVjUU9vPW4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tbiwKICBjbGllbnRfZW1haWw6IGRocnV2LXpvb21jYW1wQGtlc3RyYS1kZW1vLTQ4NzcxMS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSwKICBjbGllbnRfaWQ6IDEwNzMwNTc0NjcwNjIwMzU3Nzg5MSwKICBhdXRoX3VyaTogaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgsCiAgdG9rZW5fdXJpOiBodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiwKICBhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmw6IGh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cywKICBjbGllbnRfeDUwOV9jZXJ0X3VybDogaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9kaHJ1di16b29tY2FtcCU0MGtlc3RyYS1kZW1vLTQ4NzcxMS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSwKICB1bml2ZXJzZV9kb21haW46IGdvb2dsZWFwaXMuY29tCn0=
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra_postgres:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          server:
            basicAuth:
              username: "admin@kestra.io" # it must be a valid email address
              password: Admin1234
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/app/storage"
          queue:
            type: postgres
          tasks:
            tmpDir:
              path: /tmp/kestra-wd/tmp
          url: http://localhost:8080/
    ports:
      - "8080:8080"
      - "8081:8081"
    depends_on:
      kestra_postgres:
        condition: service_started
    